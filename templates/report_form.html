<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit Incident Report - Nakuru Safety</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/report_form.css">
</head>
<body>
    <!-- Language Indicator -->
    <div class="lang-indicator">
        <span class="text-muted small">Detected:</span>
        <span class="badge bg-secondary" id="languageDetected">Auto-detecting...</span>
    </div>

    <div class="container">
        <div class="text-center text-white mb-4">
            <a href="/" class="btn btn-light mb-3">← Back to Home</a>
            <h1 class="display-5 fw-bold">Submit Incident Report</h1>
            <p class="lead">Report safely and anonymously to local police</p>
        </div>

        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="report-card p-5">
                    <div class="text-center mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                        </svg>
                        <h3 class="mt-3">Your Report is Anonymous</h3>
                        <p class="text-muted">No personal information is collected. Your safety is our priority.</p>
                    </div>

                    <form method="POST" action="/report" enctype="multipart/form-data" id="incidentForm">
                        <!-- Category Selection with Custom Option -->
                        <div class="mb-4">
                            <label for="category" class="form-label fw-bold">Incident Category *</label>
                            <select class="form-select form-select-lg" id="category" name="category" required onchange="handleCategoryChange()">
                                <option value="">Select category...</option>
                                {% for category in settings.categories %}
                                <option value="{{ category }}">{{ category }}</option>
                                {% endfor %}
                                <option value="Other">Other (Specify below)</option>
                            </select>
                            <small class="text-muted">Select the type of incident or choose "Other" to specify</small>
                        </div>

                        <!-- Custom Category Input (Hidden by default) -->
                        <div class="mb-4" id="customCategoryInput" style="display: none;">
                            <label for="customCategory" class="form-label fw-bold">Specify Incident Type *</label>
                            <input type="text" class="form-control form-control-lg" id="customCategory" name="customCategory"
                                   placeholder="e.g., Environmental pollution, Noise complaint, etc."
                                   maxlength="100">
                            <small class="text-muted">Please describe the type of incident (max 100 characters)</small>
                        </div>

                        <div class="mb-4">
                            <label for="description" class="form-label fw-bold">Detailed Description *</label>
                            <textarea class="form-control form-control-lg" id="description" name="description" rows="5" required
                                      placeholder="What happened? When? Who was involved? Any witnesses?"
                                      oninput="detectLanguage()"></textarea>
                            <small class="text-muted">Provide as many details as possible to help police respond effectively</small>
                        </div>

                        <div class="mb-4">
                            <label for="manual_location" class="form-label fw-bold">Location/Address *</label>
                            <input type="text" class="form-control form-control-lg" id="manual_location" name="manual_location" required
                                   placeholder="e.g., Near Rongai Market, Kenyatta Avenue">
                            <small class="text-muted">Be as specific as possible</small>
                        </div>

                        <div class="mb-4">
                            <label for="constituency" class="form-label fw-bold">Constituency *</label>
                            <select class="form-select form-select-lg" id="constituency" name="constituency" required>
                                <option value="">Select constituency...</option>
                                {% for constituency in constituencies %}
                                <option value="{{ constituency[0] }}">{{ constituency[0] }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- GPS Location Section -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">GPS Location (Optional)</label>
                            <button type="button" class="btn btn-outline-primary btn-lg w-100" id="captureGpsBtn" onclick="captureLocation()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 5px;">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <circle cx="12" cy="12" r="3"></circle>
                                    <line x1="12" y1="1" x2="12" y2="3"></line>
                                    <line x1="12" y1="21" x2="12" y2="23"></line>
                                    <line x1="1" y1="12" x2="3" y2="12"></line>
                                    <line x1="21" y1="12" x2="23" y2="12"></line>
                                </svg>
                                <span id="gpsButtonText">Capture GPS Location</span>
                            </button>

                            <div class="gps-status-card" id="gpsStatusCard" style="display: none;">
                                <div id="gpsStatusContent"></div>
                            </div>

                            <input type="hidden" id="lat" name="lat" value="-0.3031">
                            <input type="hidden" id="lon" name="lon" value="36.0800">
                            <input type="hidden" id="gpsWasCaptured" value="false">
                        </div>

                        <!-- File Upload Section -->
                        <div class="mb-4">
                            <label for="media" class="form-label fw-bold">Attach Photo/Video (Optional)</label>
                            <input type="file" class="form-control form-control-lg" id="media" name="media"
                                   accept="image/*,video/*" onchange="handleFileSelect(this)">
                            <small class="text-muted">JPG, PNG, MP4 | Max 10MB</small>

                            <div class="file-preview-container" id="filePreviewContainer">
                                <h6 class="mb-3">File Preview:</h6>
                                <div id="previewContent" class="text-center"></div>
                                <div class="file-info" id="fileInfo"></div>
                                <button type="button" class="btn btn-danger remove-file-btn" onclick="removeFile()">
                                    Remove File
                                </button>
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="alert alert-info">
                            <strong>Privacy Notice:</strong> This report is completely anonymous. We do not collect or store any personal information.
                        </div>

                        <button type="submit" class="btn btn-primary btn-lg w-100 py-3" id="submitBtn">
                            Submit Anonymous Report
                        </button>
                    </form>
                </div>

                <div class="text-center text-white mt-4">
                    <p>Need immediate help? Call emergency: <strong>{{ settings.emergency_number or '0725646760' }}</strong></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="success-modal" id="successModal">
        <div class="success-content">
            <div class="success-icon">✓</div>
            <h2 class="text-success mb-3">Report Submitted Successfully!</h2>
            <p class="lead">Your report has been received and forwarded to the local police station.</p>

            <div class="report-id-display">
                <p class="mb-2"><strong>Your Report ID:</strong></p>
                <div class="report-id-number" id="displayReportId"></div>
                <small class="text-muted d-block mt-2">Save this ID to track your report</small>
            </div>

            <div class="alert alert-warning">
                <small><strong>Important:</strong> Please save this Report ID. You can use it to check the status of your report.</small>
            </div>

            <div class="btn-group-modal mt-3">
                <button type="button" class="btn btn-success btn-lg" onclick="downloadReportId()">
                     Download Report ID
                </button>
                <button type="button" class="btn btn-primary btn-lg" onclick="closeSuccessModal()">
                    Close
                </button>
            </div>

            <a href="/" class="btn btn-outline-primary btn-lg mt-3 w-100">
                 Return Home
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/report_form.js"></script>
</body>
</html>